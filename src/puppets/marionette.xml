<?xml version="1.0" encoding="utf-8"?>
<mujoco model="marionette">
  <option timestep="0.01" gravity="0 0 -9.81"/>
  
  <asset>
    <texture name="grid" type="2d" builtin="checker" width="512" height="512" rgb1="0.1 0.2 0.3" rgb2="0.2 0.3 0.4"/>
    <material name="grid" texture="grid" texrepeat="1 1" texuniform="true" reflectance="0.2"/>
    <material name="puppet_skin" rgba="0.99 0.74 0.71 1"/>
    <material name="puppet_cloth" rgba="0.29 0.33 0.40 1"/>
  </asset>

  <worldbody>
    <light pos="0 0 4" dir="0 0 -1"/>
    <geom name="floor" pos="0 0 0" size="5 5 0.1" type="plane" material="grid" condim="3" friction="1 0.005 0.0001"/>
    
    <!-- Control bar (where strings attach) -->
    <body name="control_bar" pos="0 1.5 0">
      <geom type="box" size="0.3 0.05 0.05" rgba="0.5 0.5 0.5 1"/>
    </body>

    <!-- Head string attachment point -->
    <body name="head_string" pos="0 1.5 0">
      <joint name="head_string_joint" type="slide" axis="0 -1 0" range="-0.5 0.5"/>
      <geom type="cylinder" size="0.01 0.3" rgba="0.8 0.8 0.8 0.5"/>
    </body>

    <!-- Puppet body -->
    <body name="puppet" pos="0 1 0">
      <!-- Head -->
      <body name="head" pos="0 0.4 0">
        <joint name="head_yaw" type="hinge" axis="0 1 0" range="-1.57 1.57"/>
        <joint name="head_pitch" type="hinge" axis="1 0 0" range="-0.78 0.78"/>
        <geom name="head_geom" type="sphere" size="0.15" material="puppet_skin"/>
        <site name="head_attachment" pos="0 0.15 0"/>
      </body>

      <!-- Torso -->
      <body name="torso" pos="0 0 0">
        <joint name="torso_yaw" type="hinge" axis="0 1 0" range="-0.78 0.78"/>
        <joint name="torso_pitch" type="hinge" axis="1 0 0" range="-0.52 0.52"/>
        <geom name="torso_geom" type="box" size="0.15 0.2 0.1" material="puppet_cloth"/>
        
        <!-- Left Arm -->
        <body name="left_arm" pos="-0.2 0.1 0">
          <joint name="left_shoulder" type="ball" range="-1.57 1.57 -1.57 1.57 -1.57 1.57"/>
          <geom name="left_arm_geom" type="cylinder" size="0.03 0.15" material="puppet_skin"/>
          <body name="left_hand" pos="0 -0.18 0">
            <geom name="left_hand_geom" type="sphere" size="0.05" material="puppet_skin"/>
            <site name="left_hand_attachment" pos="0 -0.05 0"/>
          </body>
        </body>

        <!-- Right Arm -->
        <body name="right_arm" pos="0.2 0.1 0">
          <joint name="right_shoulder" type="ball" range="-1.57 1.57 -1.57 1.57 -1.57 1.57"/>
          <geom name="right_arm_geom" type="cylinder" size="0.03 0.15" material="puppet_skin"/>
          <body name="right_hand" pos="0 -0.18 0">
            <geom name="right_hand_geom" type="sphere" size="0.05" material="puppet_skin"/>
            <site name="right_hand_attachment" pos="0 -0.05 0"/>
          </body>
        </body>
      </body>

      <!-- Left Leg -->
      <body name="left_leg" pos="-0.1 -0.3 0">
        <joint name="left_hip" type="hinge" axis="1 0 0" range="-1.57 1.57"/>
        <geom name="left_leg_geom" type="cylinder" size="0.04 0.175" material="puppet_cloth"/>
        <body name="left_foot" pos="0 -0.2 0.05">
          <geom name="left_foot_geom" type="box" size="0.04 0.025 0.075" material="puppet_cloth"/>
          <site name="left_foot_attachment" pos="0 -0.05 0.05"/>
        </body>
      </body>

      <!-- Right Leg -->
      <body name="right_leg" pos="0.1 -0.3 0">
        <joint name="right_hip" type="hinge" axis="1 0 0" range="-1.57 1.57"/>
        <geom name="right_leg_geom" type="cylinder" size="0.04 0.175" material="puppet_cloth"/>
        <body name="right_foot" pos="0 -0.2 0.05">
          <geom name="right_foot_geom" type="box" size="0.04 0.025 0.075" material="puppet_cloth"/>
          <site name="right_foot_attachment" pos="0 -0.05 0.05"/>
        </body>
      </body>
    </body>
  </worldbody>

  <actuator>
    <!-- String controls (tendon actuators) -->
    <general name="head_string_control" tendon="head_string_tendon" gear="100" ctrllimited="true" ctrlrange="-1 1"/>
    <general name="left_hand_string_control" tendon="left_hand_string_tendon" gear="100" ctrllimited="true" ctrlrange="-1 1"/>
    <general name="right_hand_string_control" tendon="right_hand_string_tendon" gear="100" ctrllimited="true" ctrlrange="-1 1"/>
    <general name="left_foot_string_control" tendon="left_foot_string_tendon" gear="100" ctrllimited="true" ctrlrange="-1 1"/>
    <general name="right_foot_string_control" tendon="right_foot_string_tendon" gear="100" ctrllimited="true" ctrlrange="-1 1"/>
  </actuator>

  <tendon>
    <!-- String tendons connecting control points to puppet parts -->
    <spatial name="head_string_tendon" limited="true" range="0.8 1.2" width="0.002" rgba="0.8 0.8 0.8 0.5">
      <site site="head_attachment"/>
      <site site="head_string"/>
    </spatial>
    <spatial name="left_hand_string_tendon" limited="true" range="1.0 1.5" width="0.002" rgba="0.8 0.8 0.8 0.5">
      <site site="left_hand_attachment"/>
      <site site="head_string" pos="-0.2 0 0"/>
    </spatial>
    <spatial name="right_hand_string_tendon" limited="true" range="1.0 1.5" width="0.002" rgba="0.8 0.8 0.8 0.5">
      <site site="right_hand_attachment"/>
      <site site="head_string" pos="0.2 0 0"/>
    </spatial>
    <spatial name="left_foot_string_tendon" limited="true" range="1.2 1.8" width="0.002" rgba="0.8 0.8 0.8 0.5">
      <site site="left_foot_attachment"/>
      <site site="head_string" pos="-0.1 -0.5 0"/>
    </spatial>
    <spatial name="right_foot_string_tendon" limited="true" range="1.2 1.8" width="0.002" rgba="0.8 0.8 0.8 0.5">
      <site site="right_foot_attachment"/>
      <site site="head_string" pos="0.1 -0.5 0"/>
    </spatial>
  </tendon>
</mujoco>
